# Parts
1. [Setting Up Virtual Machines](https://github.com/larryn-tech/homelab/blob/main/01-vm_setup.md)
2. [Configuring Active Directory and Domain Controller](https://github.com/larryn-tech/homelab/blob/main/02-active_directory.md)
3. [Configuring Splunk](https://github.com/larryn-tech/homelab/blob/main/03-splunk_configuration.md)
4. [Simulating Brute Force Attack and Atomic Red Team](https://github.com/larryn-tech/homelab/blob/main/04-attack.md)
5. Login Hardening and Splunk Alerts (Current)
6. [Adding a Metasploitable 2 to the Network](https://github.com/larryn-tech/homelab/blob/main/06-metasploitable.md)

# Login Hardening and Splunk Alerts
In the previous part, we performed a brute-force attack with Crowbar and executed Atomic Red Team (ART) tests to observe key security events like failed logons and account creations/deletions in Splunk. In this part, we will focus on hardening login security through Group Policy Objects (GPOs) and implementing real-time alerts in Splunk to prevent and/or more quickly detect these types of attacks.

[GPOs](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/group-policy/group-policy-overview) are a collection of policy settings, rules and configurations that can be linked to specific organizational units (OUs) or the entire domain. We’ll use them to set security settings, such as password and account lockout policies, but GPOs can also be used to manage software deployment, configure user environments (such as desktop backgrounds or mapped network drives), enforce firewall rules, control access to system features, and apply automated scripts for system startup or shutdown.

In Splunk, we can create alerts that trigger when results from a saved search meet specific conditions. The alerts can be monitored and be used to trigger additional actions, such as send emails, messages, or push notifications. Splunk alerts allow us to more quickly identify and respond to issues or unusual behavior, minimizing potential downtime and/or damage.

In this part, we will:
- Create a Splunk alert when an account is locked, created, or deleted
- Use GPOs to enforce secure passwords and lockout accounts with multiple failed login attempts
- Repeat our brute force attack with Crowbar and user creation ART test
- Monitor alerts in Splunk

## `dc-server` VM
### Creating an Alert for Account Lockouts
1. Open Splunk Web by visiting [192.168.10.10:8000](https://192.168.10.10:8000)
2. Login as `Administrator` (`goldrush`, password: `splunk-serverPW1`)
3. Select **Search & Reporting** from the Apps menu
4. Run the search below:
	- The search looks for event logs generated by `dc-server` with the Windows Event ID [4740](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4740) (**A user account was locked out**)
    - It displays the affected user, event information, and the time it occurred for each event
    - Since account lockout has not been implemented yet, there should be no results at this point

```
index=endpoint host=DC-SERVER EventCode=4740
| eval Event_Time=strftime(_time, "%Y-%m-%d %H:%M:%S %Z")
| table Account_Name Message Event_Time
```

5. Click on `Save As` and select `Alert`

![dcs-lockout_alert-05]

6. Use the following settings for the alert:
   - **Title**: `Account Lockout Alert`
   - **Description**: `Alert for account lockout (Windows Event ID 4740)`
   - **Permissions**: `Private`
   - **Alert type**: `Real-time`
   - **Expires**: `24 hours`
   - **Trigger when**: `Per-Result`
   - **Trigger Actions**: `Add to Triggered Alerts`
   - **Severity**: `High`

![dcs-lockout_alert-06]

7. Click `Save` and then `View Alerts`
8. Click on `Search` to return to the **Search & Reporting** app

### Creating an Alert for New User Creations and Deletions
1. Run the following search:
	- The search looks for event logs generated by `dc-server` with the Windows Event ID [4720](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4720) (**A user account was created**) or Event ID [4726](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4726) (**A user account was deleted**)
    - For each event, the user affected, information about the event, and the time it occurred will be displayed
    - Depending on when `goldrush.sf` users were created, there may or may not be any results

```
index=endpoint host=DC-SERVER EventCode IN (4720,4726)
| eval Event_Time=strftime(_time, "%Y-%m-%d %H:%M:%S %Z")
| table Account_Name Message Event_Time
```
2. Click on `Save As` and select `Alert`
3. Use the following settings for the alert:
   - Title: `Account Creation/Deletion Alert`
   - Description: `Alert for account creation (Windows Event ID 4720) and account deletion (Windows Event ID 4726)`
   - Permissions: `Private`
   - Alert type: `Real-time`
   - Expires: `24 hours`
   - Trigger when: `Per-Result`
   - Trigger Actions: `Add to Triggered Alerts`
   - Severity: `Medium`

![dcs-account_alert-03]

4. Click `Save` and then `View Alerts`
5. You can minimize the browser for now

### Creating GPOs
1. From the Server Manager dashboard, navigate to **Tools** > **Group Policy Management**

![dcs-gpo-01]

2. Open **Forest: goldrush.sf** > **Domains** > **goldrush.sf**
3. Right-click on **Default Domain Policy** and click on `Edit...`

![dcs-gpo-03]

4. Open **Computer Configuration** > **Policies** > **Window Settings** > **Security Settings** > **Account Policies**
5. Click on **Password Policy**

6. Edit a policy by double-clicking it and make the following changes:
   - **Maximum password age**:	`999` days
   - **Minimum password age**:	`0` days
   - **Minimum password length**:	`8` characters
   - **Password must meet complexity requirements**: `Enabled`

![dcs-gpo-06]

> We can view more details about a setting by clicking on the **Explain** tab

7. In the left pane, open **Account Lockout Policy** (located directly below **Password Policy**)
8. Double-click on `Account lockout threshold`
9. Check the `Define this policy setting` box and set the number of invalid login attempts before lock out to `10`
10. When we click `OK`, the following settings will be recommended to go along with enabling `Account lockout threshold`:
    - Set lockout duration to 10 minutes
    - Reset the lockout counter after 10 minutes
    - Allow the `Administrator` account to lockout

![dcs-gpo-10]

11. Click `OK` to accept the suggested changes
12. Close the **Group Policy Management Editor** and **Group Policy Management** windows

### Require Password Change
> NOTE: The following section causes an error in my version of Server Manager (build number 10.0.26100.1591) that prevents me from logging in with a user. When attempting to log into an account with the `User must change password at login` attribute applied, any password I entered for the new password (making sure it adhere to the complexity requirements) was not being accepted. Instead, I kept receiving the message "*The user’s password must be changed before signing in.*" Other users ([1](https://community.spiceworks.com/t/server-2025-user-must-change-password-at-login-loop/1173499), [2](https://learn.microsoft.com/en-us/answers/questions/791864/password-change-logon-loop), [3](https://www.reddit.com/r/activedirectory/comments/1ioidlg/problem_user_must_change_password_at_next_logon/)) have reported similar issues. I will update this section if I find a solution.
>
> For now, I recommend skipping this section and manually changing the password via AD or the user. For this project, I applied the change password requirement just to the `gkittle` account for demonstrative purposes.

The password complexity requirements are only enforced the next time a user changes their password or when the password's maximum age is reached, i.e. `gkittle` would still be able to logon to `win-workstation` with the password `goldrush-PW1`. To require a user to change their password, we’ll need to select that option for each user.
1. In the Server Manager dashboard, go to **Tools** > **Active Directory Users and Computers**
2. Click on the `Offense` OU and highlight one of the users
3. Press **CTRL+A** to select all users in the OU
4. With all of the users highlighted, right-click on a user and click on `Properties`

![dcs-require_pw-04]

5. Switch to the **Account** tab and check the two boxes next to `User must change password at login`

![dcs-require_pw-05]

6. Click `Apply` and then `OK`
7. Repeat steps 2-6 for the `Coaches`, `Defense`, and `Special Teams` OUs

### Unlocking an Account
An account is automatically unlocked after the **Account lockout duration** (10 minutes in this case) has passed. An administrator can manually unlock an account with the following steps.
1. In the Server Manager dashboard, open **Active Directory Users and Computers** from the **Tools** menu
2. Right-click on the `goldrush.sf` domain and click on `Find...`

![dcs-unlock-02]

3. Enter the username or first and/or last name of the locked account and click on `Find Now`
4. Right-click on the user and select `Properties`

![dcs-unlock-04]

5. Switch to the **Account** tab, and check the `Unlock account` box

![dcs-unlock-05]

6. Click `Apply` and then `OK`
7. The account should be unlocked and the user should be able to logon again

## `win-workstation` VM
### Required Password Change
1. If you are still logged on to an user, sign out of the account
2. When logging into an account with the old password (e.g. `gkittle` with `goldrush-PW1`), you’ll be required to change it

![win-required_pw-02]

3. Enter and confirm the new password, ensuring it adheres to the new password requirements

> NOTE: This is where I would be stuck and unable to bypass

### Testing Lockout Policy
When attempting to logon to the `gkittle` account with the wrong password 10 times, I am presented with the following screen indicating that the user account is locked.

![win-lockout-00]

I will either have to wait 10 minutes before trying again or have an administrator unlock the account in Active Directory.

### Manually Changing Password
1. Logon to an account with the original password (ex. `bpurdy` with `goldrush-PW1`)
2. Enter **CTRL+ALT+DEL** in the VM by using **Input** > **Keyboard** > **Insert Ctrl-Alt-Del**
3. Select `Change password`

![win-manual_pw-03]

4. Enter the old and new passwords, making sure to adhere to the new password requirements
   - For the next section, I changed the password for `bpurdy` to `P@ssw0rd321`

![win-manual_pw-04]

## `attacker` VM

### Updating Password Wordlist
Using a strong password makes it more difficult for unauthorized users to access an account via brute force attacks and dictionary attacks. Even if the password is in a password wordlist, enabling account lockout can make it significantly harder for attackers to brute force. To test this, we’ll update the `passwords.txt` file to contain the new password.
1. Open the `passwords.txt` file located in the Desktop
2. Add `bpurdy`’s new password (`P@ssw0rd321`) to the end of the list

![atk-wordlist-02]

3. Save the file

### Performing Brute Force Attack With Crowbar
1. In the Terminal, navigate to the Desktop folder with `cd ~/Desktop/`
2. Run the following command: `crowbar -b rdp -u bpurdy -C passwords.txt -s 192.168.10.100/32`

![atk-crowbar-02]

3. We’ll notice that this time, even though the password is contained in the `passwords.txt` wordlist, Crowbar is unable to crack the password due to the account lockout after the first 10 attempts

## `dc-server VM`
### Creating and Deleting Accounts with ART
1. Run the command `Invoke-AtomicTest T1136.001` in PowerShell
   - If you encounter a "*The term “Invoke-AtomicTest” is not recognized […]*" error, you may need to import the ART module by running the following command before retrying the test

```powershell
Import-Module “C:\AtomicRedTeam\invoke-atomicredteam\Invoke-AtomicRedTeam.psd1” -Force
```

![dcs-art-01]

### Viewing Alerts in Splunk Web
1. Open Splunk Web and navigate to **Activity** > **Triggered Alerts**

![dcs-alerts-01]

2. Here we can see the alerts that were triggered within the past 24 hours, along with the time, the alert name, and its severity level.
   - Two alerts are Account Lock Alerts - one from testing the lockout policy with `gkittle` and the other from using Crowbar to brute-force `bpurdy`’s account
   - The other four are Account Creation/Deletion Alerts - two for the creation and two for the deletion of the accounts created by ART

![dcs-alerts-02]

3. When we click on `View Results` for the latest triggered alert, we can view the search query and result that triggered the alert

![dcs-alerts-03]



[atk-crowbar-02]: ./img/05/05-atk-crowbar-02.png
[atk-wordlist-02]: ./img/05/05-atk-wordlist-02.png
[dcs-account_alert-03]: ./img/05/05-dcs-account_alert-03.png
[dcs-alerts-01]: ./img/05/05-dcs-alerts-01.png
[dcs-alerts-02]: ./img/05/05-dcs-alerts-02.png
[dcs-alerts-03]: ./img/05/05-dcs-alerts-03.png
[dcs-art-01]: ./img/05/05-dcs-art-01.png
[dcs-gpo-01]: ./img/05/05-dcs-gpo-01.png
[dcs-gpo-03]: ./img/05/05-dcs-gpo-03.png
[dcs-gpo-06]: ./img/05/05-dcs-gpo-06.png
[dcs-gpo-10]: ./img/05/05-dcs-gpo-10.png
[dcs-lockout_alert-05]: ./img/05/05-dcs-lockout_alert-05.png
[dcs-lockout_alert-06]: ./img/05/05-dcs-lockout_alert-06.png
[dcs-require_pw-04]: ./img/05/05-dcs-require_pw-04.png
[dcs-require_pw-05]: ./img/05/05-dcs-require_pw-05.png
[dcs-unlock-02]: ./img/05/05-dcs-unlock-02.png
[dcs-unlock-04]: ./img/05/05-dcs-unlock-04.png
[dcs-unlock-05]: ./img/05/05-dcs-unlock-05.png
[win-lockout-00]: ./img/05/05-win-lockout-00.png
[win-manual_pw-03]: ./img/05/05-win-manual_pw-03.png
[win-manual_pw-04]: ./img/05/05-win-manual_pw-04.png
[win-required_pw-02]: ./img/05/05-win-required_pw-02.png