# Parts
1. [Setting Up Virtual Machines](https://github.com/larryn-tech/homelab/blob/main/01-vm_setup.md)
2. [Configuring Active Directory and Domain Controller](https://github.com/larryn-tech/homelab/blob/main/02-active_directory.md)
3. [Configuring Splunk](https://github.com/larryn-tech/homelab/blob/main/03-splunk_configuration.md)
4. Simulating Brute Force Attack and Atomic Red Team (Current)
5. [Login Hardening and Splunk Alerts](https://github.com/larryn-tech/homelab/blob/main/05-login_hardening.md)

# Simulating Attacks with Kali Linux and ART
Kali Linux is a Linux distribution that comes pre-installed with hundreds of tools designed for digital forensics and penetration testing. It is intended for ethical hacking, security auditing, and learning purposes in a **controlled and legal environment**, with permission from owners.

Atomic Red Team (ART) is an open-source project that provides a collection of small, highly portable, and reproducible security tests designed to emulate specific adversarial techniques. Its primary goal is to help security teams test and validate their defenses' ability to observe, detect, and respond to attacks.

Kali Linux and Atomic Red Team are useful tools that allow organizations to proactively test their defenses, understand potential attack paths, and ultimately strengthen their overall security against real-world threats.

In this part, we will:
- Enable Remote Desktop on our `win-workstation` VM
- Run Crowbar on our `attacker` VM to brute force the Remote Desktop Protocol (RDP) on `win-workstation`
- Run an ART test on our `dc-server` VM
- View event logs generated by the attacks on Splunk Web

## Prerequisites
For this part, you should have the following VMs up and running:
- `dc-server`
- `splunk-server`
- `win-workstation`
- `attacker`

---

## `win-workstation` VM
### Enable Remote Desktop
1. Log on as `gkittle` (password: `goldrush-PW1`)
2. Search  for “This PC” in the Windows search bar and click on `Properties`
3. In the **Related settings** section and click on `Advanced system settings`
4. Log in with the `Administrator` account to continue
   - User name: `Administrator`
   - Password: `dc-serverPW1`
5. In the **System Properties** window, click on the **Remote** tab and select `Allow remote connections to this computer` under the **Remote Desktop** section
6. Click on `Select Users` and then `Add…` in the **Remote Desktop Users** window
7. In the **Select Users or Groups**, type in “George Kittle” and then click on `Check Names`
8. Add a space, repeat with “Brock Purdy”, and the click on `OK`

![win-enable-08]

9. Click on `OK` for the **Remote Desktop Users** window
10. Click on `Apply` and then `OK` for the **System Properties** window

---

## `attacker` VM
### Installing Crowbar and Preparing a Password Wordlist

For this exercise, we’ll use the first 20 words from the `rockyou.txt` file and add the password of our `goldrush.sf` domain user. This simulates the scenario where a user is using a weak password that is found in a wordlist.

1. In the Terminal, we’ll install Crowbar using `sudo apt-get install -y crowbar`
2. Navigate to the folder containing the `rockyou.txt` wordlist with the command `cd /usr/share/wordlists`
3. Unzip the file with the command `sudo gunzip rockyou.txt.gz`
4. When we run `ls`, we should now see a `rockyou.txt` file

![atk-install_cb-04]

5. We’ll create our own wordlist using the first 20 words in `rockyou.txt` with the command `head -n 20 rockyou.txt > ~/Desktop/passwords.txt`
6. We’ll edit the `passwords.txt` wordlist by running `nano ~/Desktop/passwords.txt`
7. Use the **down arrow** to scroll to the bottom of the list and add `goldrush-PW1`

![atk-install_cb-07]

8. Press **CTRL + S** to save and then **CTRL + X** to exit

### Performing Brute Force Attack With Crowbar
1. In the Terminal, navigate to the Desktop folder with `cd ~/Desktop/`
2. Run the following command: `crowbar -b rdp -u bpurdy -C passwords.txt -s 192.168.10.100/32`
    - `-b rdp` specifies that we are targeting the RDP service
    - `-u bpurdy` specifies the account we are targeting
    - `-C passwords.txt` specifies the wordlist that we are using
    - `-s 192.168.10.100/32` specifies that we are targeting a single host at the specified IP address as opposed to an entire subnet
3. Once the command completes, we should get see the message `RDP-SUCCESS` along with `bpurdy`’s password `goldrush-PW1`

![atk-run_cb-03]

4. The `crowbar` command also outputs two files:
   - `crowbar.out` stores successful attempts and saves the messages that were displayed in the Terminal
   - `crowbar.log` stores all brute force attempts

![atk-run_cb-04]

---

## `dc-server` VM
### Viewing Failed Logon Events in Splunk
1. Logon to Splunk Web by visiting [192.168.10.10:8000](https://192.168.10.10:8000)
   - Username: `goldrush`
   - Password: `splunk-serverPW1`
2. In the **Apps** sidebar, click on `Search & Reporting`
3. In the search bar, enter `index=endpoint bpurdy` to find events related to the `bpurdy` user

![dcs-spl-03]

4. Under **Interesting Fields**, click on `EventCode`
5. We’ll notice that there are 20 events with an `EventCode` of `4625`
   - `4625` is a [Windows Security Log Event](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4625) that corresponds to a failed log on attempt
   - This indicates that someone failed to log on to the `bpurdy` account 20 times
   - Recall that our `passwords.txt` file had 21 words total (20 from `rockyou.txt` and the correct one that we added)

![dcs-spl-05]

6. When we click on `4625`, our search will be updated to `index=endpoint bpurdy EventCode=4625` and further filter our events to the user and the `4625 EventCode`
   - If we choose one of the events and click on `Show all 61 lines`, we can get more information including the hostname and IP address of the computer attempting to log on from

![dcs-spl-06]

7. Looking through the events, we’ll see that they all occurred within a few seconds of each other — suggesting a brute force attack. We can visualize this by modifying our search to:

```
index=endpoint bpurdy EventCode=4625 | timechart count
```

![dcs-spl-07]

### Installing ART
1. In the `C:\` drive, create an empty folder with the name `AtomicRedTeam`
2. Enter “Virus & threat protection” in the Windows search bar and click on `Open`
3. Under **Virus & threat protection settings**, click on `Manage settings`
4. Under **Exclusions**, click on `Add or remove exclusions`
5. Click on `Add an exclusion` and select `Folder`
6. Select the `AtomicRedTeam` folder and click on `Select Folder`

![dcs-install_art-06a]
![dcs-install_art-06b]

7. Open PowerShell as Administrator and run the following commands:
```powershell
Set-ExecutionPolicy Bypass CurrentUser
```
```powershell
IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing)
```
```powershell
Install-AtomicRedTeam -getAtomics
```

8. Press **Y** and **Enter** to install the NuGet provider

![dcs-install_art-08]

### Running an ART Test
1. If we open the `AtomicRedTeam/atomics` folder, we’ll see the list of tests that we can run
   - Each of the `T#` folders corresponds to a Technique defined by the [MITRE ATT&CK Framework](https://attack.mitre.org/matrices/enterprise/)
   - For example, `T1136.001` refers to the [Local Account sub-technique](https://attack.mitre.org/techniques/T1136/001/) of the Create Account technique
   - Each folder contains a `.yaml` file that defines the attack procedures, as well as an easier-to-read `.md` version

![dcs-run_art-01]

2. To run a test, run the command `Invoke-AtomicTest T1136.001` in PowerShell
3. We’ll see that the test created and deleted a `NewLocalUser` user

![dcs-run_art-03]

4. Open Splunk Web by visiting `192.168.10.10:8000` and log in as `goldrush` (password: `splunk-serverPW1`)
5. In the **Apps** sidebar, click on `Search & Reporting`
6. In the search bar, enter `index=endpoint NewLocalUser` to find events related to the `NewLocalUser` user

![dcs-run_art-06]



[atk-install_cb-04]: ./img/04/04-atk-install_cb-04.png
[atk-install_cb-07]: ./img/04/04-atk-install_cb-07.png
[atk-run_cb-03]: ./img/04/04-atk-run_cb-03.png
[atk-run_cb-04]: ./img/04/04-atk-run_cb-04.png
[dcs-install_art-08]: ./img/04/04-dcs-install_art-08.png
[dcs-install_art-06a]: ./img/04/04-dcs-install_art-06a.png
[dcs-install_art-06b]: ./img/04/04-dcs-install_art-06b.png
[dcs-run_art-01]: ./img/04/04-dcs-run_art-01.png
[dcs-run_art-03]: ./img/04/04-dcs-run_art-03.png
[dcs-run_art-06]: ./img/04/04-dcs-run_art-06.png
[dcs-spl-03]: ./img/04/04-dcs-spl-03.png
[dcs-spl-05]: ./img/04/04-dcs-spl-05.png
[dcs-spl-06]: ./img/04/04-dcs-spl-06.png
[dcs-spl-07]: ./img/04/04-dcs-spl-07.png
[win-enable-08]: ./img/04/04-win-enable-08.png